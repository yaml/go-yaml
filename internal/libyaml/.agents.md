# AI Assistant Guidelines for internal/libyaml Package

## Package Overview

This package provides low-level YAML processing through a 3-stage pipeline:
**Scanner → Parser → Emitter**

It implements libyaml C library functionality in Go.

**Read first**: `../../.agents.md` for project-wide Go guidelines

## Data-Driven Test Framework

### Architecture

This package uses a **data-driven testing approach**:
- Test data: YAML files in `testdata/` directory
- Test logic: Go files (`*_test.go`)
- **One-to-one pairing**: Each `testdata/foo.yaml` has a `foo_test.go`

### Critical Rules for Test Types

**Test type names in YAML files use HYPHENS, not underscores.**

```yaml
# ✅ CORRECT format in testdata/*.yaml files
- scan-tokens:
    name: Simple scalar

- scan-tokens-detailed:
    name: Quoted scalar

- emit-config:
    name: Custom indent

- parse-events-detailed:
    name: Anchor test
```

**Go code MUST use the EXACT same format:**

```go
// ✅ CORRECT: Matches YAML format exactly
switch tc.Type {
case "scan-tokens":
    runScanTokensTest(t, tc)
case "scan-tokens-detailed":
    runScanTokensDetailedTest(t, tc)
case "emit-config":
    runEmitConfigTest(t, tc)
}

// ❌ WRONG: Using underscores when YAML uses hyphens
switch tc.Type {
case "emit_config":  // Will never match!
    runEmitConfigTest(t, tc)
}
```

### Test Type Reference

**Scanner tests:**
- `scan-tokens` - Token sequence verification
- `scan-tokens-detailed` - Token properties (value, style)
- `scan-error` - Error detection

**Parser tests:**
- `parse-events` - Event sequence verification
- `parse-events-detailed` - Event properties (anchor, tag, value)
- `parse-error` - Error detection

**Emitter tests:**
- `emit` - Event-to-YAML conversion
- `emit-config` - Emit with configuration options
- `roundtrip` - Parse → emit verification
- `emit-writer` - Emit to io.Writer

**API tests:**
- `api-new` - Constructor tests
- `api-method` - Method and field state tests
- `api-panic` - Methods that should panic
- `api-delete` - Cleanup tests
- `api-new-event` - Event constructor tests

**Utility tests:**
- `enum-string` - String() method tests for enums
- `style-accessor` - Style accessor method tests

**Other tests:**
- `scalar-resolution` - Scalar type resolution tests
- `char-predicate` - Character classification predicates
- `char-convert` - Character conversion functions

### TestCase Struct Fields

**ACTUAL field names** (verified against `yamldatatest_test.go`):

```go
type TestCase struct {
    Name         string        // Test case name
    Type         string        // Test type (e.g., "scan-tokens")

    // Input
    Yaml         string        // Input YAML string
    InputHex     string        // Hex-encoded input
    InputBytes   string        // Byte string input

    // Expected results
    Want         interface{}   // Generic expected result
    WantSpecs    []EventSpec   // For detailed event tests
    WantTokens   []TokenSpec   // For detailed token tests
    WantContains []string      // For emit tests
    WantEncoding string        // For encoding tests
    WantData     string        // For reader tests
    WantEOF      bool          // For reader tests

    // Test data
    Events       []EventSpec   // Events to emit (emit tests)
    Config       EmitterConfig // Emitter configuration
    Cases        []CharTestCase// Character test cases

    // API tests
    Constructor  string        // Constructor name (e.g., "NewParser")
    Method       []interface{} // Method call [name, args...]
    Setup        interface{}   // Setup method call
    Checks       []FieldCheck  // Field validations
    Bytes        bool          // Convert string args to []byte

    // Other
    Function     string        // Function to call
    Input        ByteInput     // Byte input data
    Index        int           // Index parameter
    Args         Args          // Method arguments
    Output       string        // Output handler type
    Handler      string        // Handler type
    Enum         []interface{} // [Type, Value] for enum tests
    StyleTest    []interface{} // [Method, STYLE] for style tests
}
```

**❌ WRONG field names to avoid:**
- `Find` (doesn't exist, use `Want`)
- `detailed` (doesn't exist, test type name indicates detailed mode)

### Adding New Tests

#### Step 1: Add test case to YAML file

```yaml
# testdata/scanner.yaml

- scan-tokens:
    name: Your test name here
    yaml: |-
      your: yaml
      here: test
    want:
    - STREAM_START_TOKEN
    - BLOCK_MAPPING_START_TOKEN
    - SCALAR_TOKEN
    - SCALAR_TOKEN
    - SCALAR_TOKEN
    - SCALAR_TOKEN
    - BLOCK_END_TOKEN
    - STREAM_END_TOKEN
```

**Rules:**
- Use test type as key: `scan-tokens:`, `emit-config:`, etc.
- Use **hyphens** not underscores in type names
- `name` should use title case: "Simple mapping", "Block scalar"
- `yaml` field uses `|-` for literal block scalars
- `want` field format depends on test type (see examples in testdata files)

#### Step 2: Verify test handler exists

```go
// scanner_test.go

func TestScanner(t *testing.T) {
    RunTestCases(t, "scanner.yaml", map[string]TestHandler{
        "scan-tokens":          runScanTokensTest,
        "scan-tokens-detailed": runScanTokensDetailedTest,
        "scan-error":           runScanErrorTest,
        // Add new handler here if needed
    })
}
```

**The map keys MUST match the YAML type names exactly** (with hyphens).

#### Step 3: Run the test

```bash
go test ./internal/libyaml -run TestScanner -v
```

### Test Handler Pattern

```go
func runScanTokensTest(t *testing.T, tc TestCase) {
    t.Helper()  // Always include this in test helpers!

    // 1. Type assert Want field to expected type
    wantSlice, ok := tc.Want.([]interface{})
    assert.Truef(t, ok, "Want should be []interface{}, got %T", tc.Want)

    // 2. Perform test operation
    types, ok := scanTokens(tc.Yaml)
    assert.Truef(t, ok, "scanTokens() failed")

    // 3. Validate results with assertions
    assert.Equalf(t, len(wantSlice), len(types),
        "got %d tokens, want %d", len(types), len(wantSlice))

    for i, expected := range wantSlice {
        assert.Equalf(t, expected, types[i],
            "token[%d] = %v, want %v", i, types[i], expected)
    }
}
```

**Pattern rules:**
- Always use `t.Helper()` as first line
- Use type assertions with explicit `ok` check
- Use `assert.Truef`, `assert.Equalf` for better error messages
- Include context in assertion messages (indices, field names, etc.)

### Constant Names and Values

When referencing YAML constants in test data, use the exact names:

**Scalar Styles (use these names in YAML):**
```
PLAIN_SCALAR_STYLE
SINGLE_QUOTED_SCALAR_STYLE
DOUBLE_QUOTED_SCALAR_STYLE
LITERAL_SCALAR_STYLE
FOLDED_SCALAR_STYLE
```

**Token Types:**
```
STREAM_START_TOKEN
STREAM_END_TOKEN
SCALAR_TOKEN
KEY_TOKEN
VALUE_TOKEN
ALIAS_TOKEN
ANCHOR_TOKEN
TAG_TOKEN
BLOCK_MAPPING_START_TOKEN
FLOW_MAPPING_START_TOKEN
BLOCK_SEQUENCE_START_TOKEN
FLOW_SEQUENCE_START_TOKEN
BLOCK_END_TOKEN
```

**Event Types:**
```
STREAM_START_EVENT
STREAM_END_EVENT
DOCUMENT_START_EVENT
DOCUMENT_END_EVENT
SCALAR_EVENT
MAPPING_START_EVENT
MAPPING_END_EVENT
SEQUENCE_START_EVENT
SEQUENCE_END_EVENT
ALIAS_EVENT
```

**Encoding:**
```
UTF8_ENCODING
UTF16LE_ENCODING
UTF16BE_ENCODING
```

**Styles:**
```
PLAIN_SCALAR_STYLE
SINGLE_QUOTED_SCALAR_STYLE
DOUBLE_QUOTED_SCALAR_STYLE
BLOCK_MAPPING_STYLE
FLOW_MAPPING_STYLE
BLOCK_SEQUENCE_STYLE
FLOW_SEQUENCE_STYLE
```

These are defined in `yamldatatest_test.go:constantMap`.

### Common Patterns

#### Parsing Enums from Strings

```go
func ParseTokenType(t *testing.T, s string) TokenType {
    t.Helper()
    val := resolveConstant(t, s)
    return TokenType(val)
}

func ParseScalarStyle(t *testing.T, s string) ScalarStyle {
    t.Helper()
    val := resolveConstant(t, s)
    return ScalarStyle(val)
}
```

#### Using Reflection for Field Access

```go
func getFieldValue(t *testing.T, obj interface{}, fieldName string) interface{} {
    t.Helper()

    v := reflect.ValueOf(obj)
    if v.Kind() == reflect.Ptr {
        v = v.Elem()
    }

    field := v.FieldByName(fieldName)
    if !field.IsValid() {
        t.Fatalf("field %s not found in %T", fieldName, obj)
    }

    return field.Interface()
}
```

## Documentation Standards

See `README.md` for the authoritative test framework documentation.

**When updating README.md:**
1. Read the actual Go struct definitions first
2. Verify field names exist before documenting them
3. Test examples are valid (don't include non-existent fields)
4. Test type names use hyphens consistently
5. Double-check against actual testdata YAML files

**From PR #194 review - mistakes to avoid:**
- ❌ Don't reference `Find` field (doesn't exist, it's `Want`)
- ❌ Don't show `detailed: true` in examples (doesn't exist)
- ❌ Don't mix underscores and hyphens in test type names

## File Organization

```
internal/libyaml/
├── scanner.go              # Scanner implementation
├── parser.go               # Parser implementation
├── emitter.go              # Emitter implementation
├── scanner_test.go         # Scanner tests (pairs with testdata/scanner.yaml)
├── parser_test.go          # Parser tests
├── emitter_test.go         # Emitter tests
├── yamldatatest_test.go    # Test framework implementation
├── yamldatatest_loader.go  # YAML test data loader
├── README.md               # Complete test framework documentation
└── testdata/               # Test data (Go build tool ignores this)
    ├── scanner.yaml        # Scanner test cases
    ├── parser.yaml         # Parser test cases
    ├── emitter.yaml        # Emitter test cases
    └── ...                 # Other test data files
```

## Before Submitting Code

**Package-specific checklist:**
1. ✅ Test type names in YAML use hyphens: `emit-config`, not `emit_config`
2. ✅ Go switch/if statements use exact YAML format
3. ✅ Documentation references actual struct fields (not `Find` or invented fields)
4. ✅ Examples in docs use only valid fields
5. ✅ New test cases added to appropriate `testdata/*.yaml` file
6. ✅ Test handler registered in `map[string]TestHandler`
7. ✅ All tests pass: `go test ./internal/libyaml -v`

**Then follow project-wide checklist in `../../.agents.md`**
